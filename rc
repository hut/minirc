#!/bin/sh
#===================
# define daemons
ALL_DAEMONS="syslog-ng iptables crond dbus dhcpcd sshd alsa privoxy acpid mpd vsftpd lighttpd ntpd"
DEFAULT_DAEMONS="$ALL_DAEMONS"

# Choose the udev implementation
#UDEV="systemd"
UDEV="busybox"

# /etc/minirc.conf gives you a chance to override the daemon variables
test -f /etc/minirc.conf && source /etc/minirc.conf

on_boot() {
    #===================
    # mount the API filesystem
    # /proc, /sys, /run, /dev, /run/lock, /dev/pts, /dev/shm
    echo_color 3 mounting API filesystem...
    mountpoint -q /proc    || mount -t proc proc /proc -o nosuid,noexec,nodev
    mountpoint -q /sys     || mount -t sysfs sys /sys -o nosuid,noexec,nodev
    mountpoint -q /run     || mount -t tmpfs run /run -o mode=0755,nosuid,nodev
    mountpoint -q /dev     || mount -t devtmpfs dev /dev -o mode=0755,nosuid
    mkdir -p /dev/{pts,shm}
    mountpoint -q /dev/pts || mount -t devpts devpts /dev/pts -o mode=0620,gid=5,nosuid,noexec
    mountpoint -q /dev/shm || mount -t tmpfs shm /dev/shm -o mode=1777,nosuid,nodev

    #===================
    # initialize system
    echo_color 3 setting up loopback device...
    /usr/sbin/ip link set up dev lo

    echo_color 3 initializing udev...
    if [ "$UDEV" == systemd ]; then
        /usr/bin/udevd --daemon
        /usr/bin/udevadm trigger --action=add --type=subsystems
        /usr/bin/udevadm trigger --action=add --type=devices
    else # use busybox mdev as fallback:
        busybox mdev -s
        echo /sbin/mdev > /proc/sys/kernel/hotplug
    fi

    echo_color 3 setting hostname...
    cat /etc/hostname >| /proc/sys/kernel/hostname

    echo_color 3 mounting...
    mount -a
    mount -o remount,rw /

    #===================
    # load rc.local
    echo_color 3 loading /etc/rc.local...
    source /etc/rc.local
    
    #===================
    # start the default daemons
    echo_color 3 starting daemons...
    for dmn in $DEFAULT_DAEMONS; do
        start_process "$dmn"
    done
}

start_process() {
    echo_color 2 starting "$1"...
    case "$1" in
    alsa)
        alsactl restore;;
    dbus)
        dbus-launch;;
    iptables)
        /usr/sbin/iptables-restore < /etc/iptables/iptables.rules;;
    sshd)
        /usr/sbin/sshd;;  # requires an absolute path
    privoxy)
        /usr/sbin/privoxy --user privoxy.privoxy /etc/privoxy/config;;
    dhcpcd)
        /usr/sbin/dhcpcd -qb eth0;;
    vsftpd)
        /usr/sbin/vsftpd &;;
    lighttpd)
        /usr/sbin/lighttpd -f /etc/lighttpd/lighttpd.conf;;
    ntpd)
        /usr/bin/ntpd -g -u ntp;;
    *)
        # fallback: start the command
        "$1";;
    esac
}

stop_process() {
    echo_color 1 stopping "$1"...
    case "$1" in
    alsa)
        alsactl store;;
    dbus)
        killall dbus-launch
        killall dbus-daemon;;
    iptables)
        for table in $(cat /proc/net/ip_tables_names); do
            iptables-restore < /var/lib/iptables/empty-$table.rules
        done;;
    *)
        # fallback: kill all processes with the name of the command
        killall "$1";;
    esac
}

poll_process() {
    case "$1" in
    alsa)
        return 0;;  # doesn't make much sense for this service
    iptables)
        iptables -L | grep -m 1 -q '^ACCEPT\|^REJECT';;
    *)
        # fallback: check if any processes of that name are running
        pgrep "$1" >& /dev/null;;
    esac
}

echo_color() {
  color=$1
  shift
  echo -e "[1;3${color}m$@[0m"
}


#===================
# handle arguments
case "$1" in
init)
    on_boot;;
start)
    shift
    [ -n "$1" ] && which="$@" || which="$ALL_DAEMONS"
    for dmn in $which; do
        start_process "$dmn"
    done;;
stop)
    shift
    [ -n "$1" ] && which="$@" || which="$ALL_DAEMONS"
    for dmn in $which; do
        stop_process "$dmn"
    done;;
restart)
    shift
    [ -n "$1" ] && which="$@" || which="$ALL_DAEMONS"
    for dmn in $which; do
        stop_process "$dmn"
        start_process "$dmn"
    done;;
''|list)
    # list all daemons and their status
    for dmn in $ALL_DAEMONS; do
        if poll_process "$dmn" >& /dev/null; then
            echo_color 2 [X] $dmn
        else
            echo_color 0 [ ] $dmn
        fi
    done;;
--version)
    echo minirc 0.1
    exit;;
*)
    echo 'usage: rc [--help] [--version] <action> [list of daemons]'
    echo
    echo 'Actions:'
    echo '  rc list   shows status of all daemons (default action)'
    echo '  rc init   initialize the system (use in /etc/inittab only!)'
    echo '  rc start daemon1 daemon2...  starts up daemons'
    echo '  rc stop daemon1 daemon2...   stops up daemons'
    ;;
esac
